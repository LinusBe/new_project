{% extends "master.html" %}

{% block title %}
  Analyse: {{ data_file.title }}
{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@finos/perspective-viewer/dist/css/material.css" />

    <style>
        /* Maximale Größe für den Analysebereich nutzen */
        #main-container {
            max-width: 98%;
            padding-bottom: 10px;
        }

        /* Styling für den Perspective Viewer Container */
        #perspective-container {
            /* Höhe festlegen, damit Perspective den Platz füllt (wichtig!) */
            height: 80vh;
            min-height: 600px;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid var(--dws-lightgrey);
            position: relative;
            /* Für das Loader-Overlay */
        }

        perspective-viewer {
            width: 100%;
            height: 100%;
        }

        /* Lade-Overlay Styling */
        #loader {
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 100;
            font-size: 1.1em;
            color: var(--dws-grey);
            text-align: center;
            padding: 20px;
        }

        /* --- Excel Sheet Selector --- */
        .analysis-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 5px;
        }
        .sheet-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sheet-selector label {
            font-weight: bold;
            margin-bottom: 0;
        }
        .sheet-selector select {
            width: auto;
            min-width: 200px;
            padding: 10px;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@finos/perspective/dist/umd/perspective.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@finos/perspective-viewer/dist/umd/perspective-viewer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@finos/perspective-viewer-datagrid/dist/umd/perspective-viewer-datagrid.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@finos/perspective-viewer-d3fc/dist/umd/perspective-viewer-d3fc.js"></script>
{% endblock %}

{% block content %}
  <h1>Datenanalyse: {{ data_file.title }}</h1>
  <p>
    <a href="{% url 'dashboard' %}">&larr;
 Zurück zum Dashboard</a> |
    <a href="{% url 'datafiles:download' data_file.id %}">Originaldatei herunterladen</a>
  </p>

  {% if sheet_names|length > 1 %}
  <div class="analysis-controls">
      <div class="sheet-selector">
          <label for="sheet-select">Excel Arbeitsblatt:</label>
          <select id="sheet-select">
              {% for sheet in sheet_names %}
              <option value="{{ sheet }}" {% if sheet == selected_sheet %}selected{% endif %}>

                   {{ sheet }}
              </option>
              {% endfor %}
          </select>
      </div>
  </div>
  {% endif %}

  <div id="perspective-container">
    <div id="loader"><span>⏳ Lade und analysiere Daten...<br><small>(Die Daten werden optimiert übertragen. Dies kann bei großen Dateien einen Moment dauern.)</small></span></div>
    <perspective-viewer id="viewer"></perspective-viewer>
  </div>


   <script>
    // Wartet, bis das gesamte HTML-Dokument geladen ist
    document.addEventListener("DOMContentLoaded", function() {

        // Sheet-Wechsel
        document.getElementById('sheet-select')?.addEventListener("change", (event) => {
          window.location.href = "?sheet=" + encodeURIComponent(event.target.value);
        });

        // Async-Funktion, sicher innerhalb des Listeners definiert
        async function loadData() {
            const viewer = document.getElementById("viewer");
            const loader = document.getElementById("loader");
            try {
                // 1. URL für den Datenabruf konstruieren (?format=arrow).
                let dataUrl = "{% url 'datafiles:analyze' data_file.id %}?format=arrow";

                const selectedSheet = "{{ selected_sheet|escapejs }}";
                // WICHTIG: Prüfen, ob der Wert gültig UND nicht der String "None" ist (Django Template Verhalten).
                if (selectedSheet && selectedSheet !== 'None') {
                    dataUrl += "&sheet=" + encodeURIComponent(selectedSheet);
                }

                // 2. Daten vom Server abrufen (Streaming)
                const response = await fetch(dataUrl);
                if (!response.ok) {
                    // Fehlerbehandlung, wenn der Server (z.B. views.py) einen Fehler meldet (Status 500/404)
                    const errorText = await response.text();
                    throw new Error(`Server-Fehler (Status ${response.status}): ${errorText}`);
                }

                // 3. Antwort als ArrayBuffer lesen (Binärdaten/Arrow Stream)
                const buffer = await response.arrayBuffer();
                if (buffer.byteLength === 0) {
                    loader.textContent = "Die Datei oder das ausgewählte Sheet ist leer.";
                    return;
                }

                // 4. Daten in Perspective laden (via Worker)

                // --- KORREKTUR für UMD ---
                // 4a. Worker-Instanz vom globalen 'perspective'-Objekt holen
                const worker = perspective.worker();

                // 4b. .table() auf der Worker-Instanz aufrufen
                const table = await worker.table(buffer);
                // --- ENDE DER KORREKTUR ---

                // 5. Tabelle an den Viewer binden
                await viewer.load(table);
                // 6. Standardkonfiguration des Viewers
                await viewer.restore({
                    plugin: "Datagrid", // Standardansicht ist die Tabelle
                    settings: true,     // Zeigt das Konfigurationsmenü (Sidebar) an
                    theme: "Material Light"
                });

                // 7. Lade-Overlay entfernen
                loader.style.display = "none";
            } catch (error) {
                console.error("Fehler während der Datenanalyse:", error);
                loader.innerHTML = `<span style="color: red;">Kritischer Fehler beim Laden oder Verarbeiten der Daten.<br><small>${error.message}</small></span>`;
            }
        }

        // Startet den Ladevorgang, sobald der DOM bereit ist.
        loadData();
    });
  </script>
{% endblock %}
